---
import NavBar from '../components/NavBar.astro';
import Footer from '../components/Footer.astro';
import '../styles/tokens.css';

export interface Props {
  title: string;
  description: string;
  lang: 'en' | 'pl' | 'de';
  ogImage?: string;
}

const { title, description, lang, ogImage } = Astro.props;

// Define alternate URLs for hreflang
// Note: `trailingSlash: 'always'` means `Astro.url.pathname` already ends with `/`.
// We normalize to avoid generating `//` in hreflang URLs.
const baseUrl = 'https://janczura.com';
const currentPath = Astro.url.pathname;
const canonicalUrl = `${baseUrl}${currentPath}`;

const supportedLangs = ['en', 'pl', 'de'] as const;
type SupportedLang = (typeof supportedLangs)[number];

const stripTrailingSlashes = (path: string) => path.replace(/\/+$/, '');
const ensureLeadingSlash = (path: string) =>
  path.startsWith('/') ? path : `/${path}`;
const ensureTrailingSlash = (path: string) => `${stripTrailingSlashes(path)}/`;

const getAltPathForLang = (targetLang: SupportedLang) => {
  const normalized = stripTrailingSlashes(currentPath);
  const parts = normalized.split('/').filter(Boolean); // e.g. ["en","projects"]
  const first = parts[0] as string | undefined;
  const rest = supportedLangs.includes(first as SupportedLang)
    ? parts.slice(1)
    : parts;
  const rebuilt = ensureLeadingSlash([targetLang, ...rest].join('/'));
  return ensureTrailingSlash(rebuilt);
};

const alternateUrls: Record<SupportedLang, string> = {
  en: `${baseUrl}${getAltPathForLang('en')}`,
  pl: `${baseUrl}${getAltPathForLang('pl')}`,
  de: `${baseUrl}${getAltPathForLang('de')}`,
};

const structuredData = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'Person',
      '@id': 'https://janczura.com/#person',
      name: 'Jacek Janczura',
      alternateName: 'Jacek Janczura',
      jobTitle: 'AI Architect & CTO',
      description:
        'Co-founder & CTO at Jaden Data. AI and Cloud Architect specializing in enterprise LLM platforms, RAG systems, and secure cloud architectures. Transforming operational complexity into competitive advantage through process intelligence.',
      url: 'https://janczura.com',
      image: 'https://janczura.com/images/headshot.jpg',
      sameAs: [
        'https://linkedin.com/in/jacekjanczura',
        'https://github.com/jjanczur',
      ],
      knowsAbout: [
        'Artificial Intelligence',
        'Machine Learning',
        'LLM Platforms',
        'Retrieval-Augmented Generation',
        'RAG Systems',
        'Cloud Architecture',
        'AWS',
        'Azure',
        'Distributed Systems',
        'Microservices',
        'Cybersecurity',
        'ISO 27001',
        'SOC 2',
        'Process Intelligence',
        'Enterprise AI',
        'AI Native Systems',
        'Event-Driven Architecture',
        'Serverless Computing',
      ],
      hasOccupation: {
        '@type': 'Occupation',
        name: 'AI Architect & CTO',
        occupationLocation: {
          '@type': 'City',
          name: 'Berlin',
          '@id': 'https://www.wikidata.org/wiki/Q64',
        },
        skills: [
          'Enterprise LLM Platforms',
          'RAG Systems',
          'Cloud Architecture',
          'Security & Compliance',
          'Technical Leadership',
        ],
      },
      worksFor: {
        '@type': 'Organization',
        name: 'Jaden Data',
        url: 'https://jaden-data.com',
      },
      alumniOf: [
        {
          '@type': 'EducationalOrganization',
          name: 'Technische Universit√§t Berlin',
        },
        {
          '@type': 'EducationalOrganization',
          name: 'Warsaw University of Technology',
        },
      ],
      address: {
        '@type': 'PostalAddress',
        addressLocality: 'Berlin',
        addressCountry: 'DE',
      },
    },
    {
      '@type': 'WebSite',
      '@id': 'https://janczura.com/#website',
      url: 'https://janczura.com',
      name: 'Jacek Janczura',
      inLanguage: ['en', 'pl', 'de'],
      publisher: { '@id': 'https://janczura.com/#person' },
    },
    {
      '@type': 'WebPage',
      '@id': `${canonicalUrl}#webpage`,
      url: canonicalUrl,
      name: title,
      description,
      inLanguage: lang,
      isPartOf: { '@id': 'https://janczura.com/#website' },
      about: { '@id': 'https://janczura.com/#person' },
    },
  ],
};
---

<html lang={lang} data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Resource hints - Must be early to establish connections before other resources -->
    <!-- Preconnect to same origin for faster asset loading (though CSS will be inlined) -->
    <link rel="preconnect" href={baseUrl} />
    <link rel="dns-prefetch" href={baseUrl} />
    <!-- External font resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="author" content="Jacek Janczura" />
    <meta
      name="keywords"
      content="Jacek Janczura, AI Architect, CTO, Enterprise AI, LLM Platforms, RAG Systems, Cloud Architecture, ISO 27001, SOC 2, Process Intelligence, AI Native Systems, Berlin, Germany"
    />
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta
      property="og:image"
      content={ogImage || `${baseUrl}/images/headshot.jpg`}
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="Jacek Janczura" />
    <meta
      property="og:locale"
      content={lang === 'en' ? 'en_US' : lang === 'pl' ? 'pl_PL' : 'de_DE'}
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta
      name="twitter:image"
      content={ogImage || `${baseUrl}/images/headshot.jpg`}
    />
    <meta name="twitter:creator" content="@jacekjanczura" />
    <meta name="twitter:site" content="@jacekjanczura" />

    <!-- Hreflang alternates -->
    <link rel="alternate" hreflang="en" href={alternateUrls.en} />
    <link rel="alternate" hreflang="pl" href={alternateUrls.pl} />
    <link rel="alternate" hreflang="de" href={alternateUrls.de} />
    <link rel="alternate" hreflang="x-default" href={alternateUrls.en} />

    <!-- DNS prefetch and preconnect for YouTube thumbnails -->
    <link rel="dns-prefetch" href="https://i.ytimg.com" />
    <link rel="preconnect" href="https://i.ytimg.com" crossorigin />

    <!-- Google Fonts - Load asynchronously to avoid render blocking -->
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap"
      rel="stylesheet"
      media="print"
      id="google-fonts-link"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap"
        rel="stylesheet"
      />
    </noscript>
    <script is:inline>
      // Load Google Fonts asynchronously
      (function () {
        const link = document.getElementById('google-fonts-link');
        if (link) {
          link.onload = function () {
            this.media = 'all';
          };
          // Fallback: if onload doesn't fire, set media after a short delay
          setTimeout(function () {
            if (link.media === 'print') {
              link.media = 'all';
            }
          }, 100);
        }
      })();
    </script>

    <!-- JSON-LD Structured Data -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(structuredData)}
    />

    <!-- CSP Meta Tag (for GitHub Pages - HTTP headers in _headers file for Netlify/Cloudflare) -->
    <!-- Using 'unsafe-inline' for script-src to allow inline scripts on this frontend-only landing page -->
    <!-- style-src keeps 'unsafe-inline' because Astro inlines stylesheets -->
    <!-- Note: frame-ancestors is only valid in HTTP headers, not meta tags -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self' 'unsafe-inline'; frame-src https://www.youtube.com https://www.youtube-nocookie.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self'"
    />

    <!-- Theme initialization -->
    <script is:inline>
      // Simple theme initialization - read from localStorage
      try {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.dataset.theme = savedTheme;
      } catch {
        // localStorage not available, use default light theme
        document.documentElement.dataset.theme = 'light';
      }
    </script>

    <!-- Service Worker Registration for caching static assets -->
    <!-- Deferred to avoid blocking initial page load -->
    <script is:inline>
      if ('serviceWorker' in navigator) {
        // Use requestIdleCallback if available, otherwise defer with setTimeout
        const registerSW = () => {
          navigator.serviceWorker
            .register('/sw.js')
            .then(registration => {
              // eslint-disable-next-line no-console
              console.log('Service Worker registered:', registration.scope);
            })
            .catch(error => {
              // eslint-disable-next-line no-console
              console.log('Service Worker registration failed:', error);
            });
        };

        if ('requestIdleCallback' in window) {
          requestIdleCallback(registerSW, { timeout: 2000 });
        } else {
          setTimeout(registerSW, 2000);
        }
      }
    </script>
    <slot name="head" />
  </head>
  <body>
    <NavBar lang={lang} />
    <main style="min-height: calc(100vh - 64px - 120px);">
      <slot />
    </main>
    <Footer lang={lang} />
  </body>
</html>
