---
export interface Props {
  youtubeId: string;
  title: string;
  className?: string;
  priority?: boolean; // Set to true for LCP image (first video)
}

const { youtubeId, title, className = '', priority = false } = Astro.props;

// Generate thumbnail URL (maxresdefault or hqdefault as fallback)
const thumbnailUrl = `https://i.ytimg.com/vi/${youtubeId}/maxresdefault.jpg`;
---

<!-- 
  IMPORTANT: This component uses click-to-load pattern.
  NO YouTube iframe exists in initial HTML - only thumbnail image.
  YouTube scripts (~2MB) only load when user clicks play button.
-->
<div class={`video-embed ${className}`} data-youtube-id={youtubeId}>
  <!-- Thumbnail placeholder - shown initially -->
  <!-- NO iframe here - YouTube scripts only load on user click -->
  <div class="video-thumbnail" data-video-id={youtubeId}>
    <img
      src={thumbnailUrl}
      alt={title}
      loading={priority ? 'eager' : 'lazy'}
      fetchpriority={priority ? 'high' : undefined}
      class="thumbnail-image"
      data-fallback={`https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg`}
    />
    <button
      class="play-button"
      aria-label={`Play video: ${title}`}
      type="button"
    >
      <svg
        width="68"
        height="48"
        viewBox="0 0 68 48"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <path
          d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z"
          fill="red"></path>
        <path d="M45 24 27 14v20l18-10z" fill="white"></path>
      </svg>
    </button>
  </div>
  <!-- Iframe container - loaded on click -->
  <div class="video-iframe-container" style="display: none;"></div>
</div>

<script>
  // CRITICAL: YouTube iframe is ONLY created on explicit user click
  // This prevents ~3MB of YouTube JavaScript from loading on page load
  // The iframe does NOT exist in the initial HTML - it's created dynamically
  (function () {
    // Track if already initialized to prevent double initialization
    let initialized = false;

    function initVideoEmbeds() {
      // Prevent double initialization
      if (initialized) return;
      initialized = true;

      const embeds = document.querySelectorAll('.video-embed[data-youtube-id]');

      embeds.forEach(embed => {
        const youtubeId = embed.getAttribute('data-youtube-id');
        if (!youtubeId) return;

        const thumbnail = embed.querySelector('.video-thumbnail');
        const playButton = embed.querySelector('.play-button');
        const iframeContainer = embed.querySelector('.video-iframe-container');
        const thumbnailImage = embed.querySelector('.thumbnail-image');

        if (!thumbnail || !playButton || !iframeContainer) return;

        // Handle thumbnail fallback if high-res image fails to load
        if (thumbnailImage) {
          thumbnailImage.addEventListener(
            'error',
            function (this: HTMLImageElement) {
              const fallback = this.getAttribute('data-fallback');
              if (fallback && this.src !== fallback) {
                this.src = fallback;
              }
            },
          );
        }

        // Track if video is already loaded to prevent double-loading
        let videoLoaded = false;

        // Load iframe on click - ONLY when user explicitly clicks
        function loadVideo(event?: Event) {
          // Prevent default and stop propagation
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }

          // Prevent double-loading
          if (videoLoaded) return;
          videoLoaded = true;

          // Hide thumbnail
          if (thumbnail instanceof HTMLElement) {
            thumbnail.style.display = 'none';
          }

          // Create and insert iframe - this is when YouTube scripts will load
          // NO YouTube scripts load before this point
          // Privacy-focused URL parameters to minimize cookie usage:
          // - enablejsapi=0: Disables JavaScript API (reduces cookies)
          // - modestbranding=1: Reduces branding
          // - rel=0: Don't show related videos from other channels (privacy)
          // - cc_load_policy=0: Disable closed captions by default
          const iframe = document.createElement('iframe');
          // Use setAttribute for src to work with Trusted Types
          const embedUrl = `https://www.youtube-nocookie.com/embed/${youtubeId}?autoplay=1&enablejsapi=0&modestbranding=1&rel=0&cc_load_policy=0`;
          iframe.setAttribute('src', embedUrl);
          iframe.setAttribute(
            'title',
            thumbnailImage?.getAttribute('alt') || 'YouTube video',
          );
          iframe.setAttribute('width', '560');
          iframe.setAttribute('height', '315');
          iframe.setAttribute('frameborder', '0');
          iframe.setAttribute(
            'allow',
            'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share',
          );
          iframe.setAttribute('allowfullscreen', '');
          iframe.setAttribute('loading', 'lazy');
          iframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');
          iframe.className = 'video-iframe';
          iframe.setAttribute('data-loaded', 'true');

          // Show container and insert iframe
          // This is the ONLY point where YouTube scripts will be loaded
          if (iframeContainer instanceof HTMLElement) {
            iframeContainer.style.display = 'block';
            iframeContainer.appendChild(iframe);
          }
        }

        // Attach click handler - only on explicit user interaction
        // Use capture phase and once option to ensure it only fires once
        const clickOptions = { once: true, capture: true };
        playButton.addEventListener('click', loadVideo, clickOptions);
        thumbnail.addEventListener('click', loadVideo, clickOptions);

        // Also handle keyboard activation for accessibility
        playButton.addEventListener(
          'keydown',
          (e: Event) => {
            const keyEvent = e as KeyboardEvent;
            if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
              keyEvent.preventDefault();
              loadVideo(keyEvent);
            }
          },
          { once: true },
        );
      });
    }

    // Initialize when DOM is ready - defer slightly to avoid blocking
    const initWhenReady = () => {
      if ('requestIdleCallback' in window) {
        requestIdleCallback(initVideoEmbeds, { timeout: 500 });
      } else {
        // Small delay to avoid blocking main thread
        setTimeout(initVideoEmbeds, 50);
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWhenReady);
    } else {
      initWhenReady();
    }
  })();
</script>

<style>
  .video-embed {
    width: 100%;
    max-width: 560px;
    margin: 0 auto;
    aspect-ratio: 16/9;
    position: relative;
    background: #000;
    border-radius: var(--radius-m);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .video-thumbnail {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .thumbnail-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: transform 0.2s ease;
    z-index: 1;
  }

  .play-button:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .play-button:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 4px;
    border-radius: 4px;
  }

  .play-button svg {
    display: block;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
  }

  .video-iframe-container {
    width: 100%;
    height: 100%;
  }

  .video-iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: var(--radius-m);
  }
</style>
